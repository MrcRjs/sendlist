var app=angular.module("sendlist",["ui.router","uiSwitch","facebook","external","input-directives","scroll-directive","sendlist.settings","sendlist.constants","sendlist.SessionService","sendlist.AuthService","sendlist.MultimediaService","sendlist.ListsService","sendlist.SignService","sendlist.MainController","sendlist.LoginController","sendlist.ListsController","sendlist.NewListController"]),sessionResolver=["$q","ERRORS","$rootScope",function(e,t,n){return n.credentials.user?e.resolve(!0):e.reject(t.NOT_LOGGED_IN)}];app.config(["$stateProvider","$urlRouterProvider","$locationProvider","FacebookProvider","APP_KEYS",function(e,t,n,s,i){t.otherwise("/not-found"),e.state("login",{url:"/login",templateUrl:"html/login.html",controller:"LoginController",resolve:{redirect:["$q","ERRORS","$rootScope",function(e,t,n){return n.credentials.user?e.reject(t.ALREADY_LOGGED_IN):e.resolve(!0)}]}}).state("lists",{url:"/",templateUrl:"html/lists.html",controller:"ListsController",resolve:{sessionResolver:sessionResolver}}).state("list",{url:"/list/:id",templateUrl:"html/list.html",params:{list:null},controller:"NewListController",resolve:{sessionResolver:sessionResolver}}).state("not-found",{url:"/not-found",templateUrl:"html/not-found.html"}),n.html5Mode(!0),s.init(i.facebook)}]),app.run(["$rootScope","$state","ERRORS","EVENTS","SessionService","Facebook","AuthService",function(e,t,n,s,i,r,o){e.credentials=i.read(),e.credentials.user&&e.$broadcast(s.SESSION_READY,e.credentials),e.$on(s.LOGIN_SUCCESS,function(n,r){i.store(r),e.credentials=i.read(),e.$broadcast(s.SESSION_READY,e.credentials),t.go("lists")}),e.$on(s.LOGOUT,function(){i["delete"](),delete e.credentials.user,delete e.credentials.key,e.credentials={},t.go("login")}),e.$on("$stateChangeError",function(e,s,i,r,o,l){l===n.NOT_LOGGED_IN&&t.go("login")}),e.$on("$stateChangeError",function(e,s,i,r,o,l){l===n.ALREADY_LOGGED_IN&&t.go("lists")})}]),angular.module("sendlist.constants",[]).constant("ERRORS",{NOT_LOGGED_IN:"user not logged in",ALREADY_LOGGED_IN:"user already logged in"}).constant("EVENTS",{LOGIN_SUCCESS:"login successful",LOGOUT:"user logs out",SESSION_DESTROYED:"session is destroyed",SESSION_READY:"session ready"}).constant("MESSAGES",{SERVER_ERROR:"There was an error, please try again"}),angular.module("external",[]).factory("jsSHA",function(){return window.jsSHA}).factory("_update",function(){return function(e,t){for(var n in t)t.hasOwnProperty(n)&&e.hasOwnProperty(n)&&(t[n]=e[n])}}),angular.module("sendlist.settings",[]).constant("APP_KEYS",{facebook:"1093183720723157"}),angular.module("sendlist.ListsController",["external"]).controller("ListsController",["$scope","$rootScope","$state","ListsService","EVENTS","MESSAGES","_update",function(e,t,n,s,i,r,o){e.loaded=!1,e.credentials=t.credentials,e.lists=[],e.new_list_input_lock=!1,e.addList=function(t){if(!e.new_list_input_lock){e.new_list_input_lock=!0;var i={title:t,items:[]};s.add(i,e.credentials).then(function(t){t.success?n.go("list",{list:t.list,id:t.list._id}):alert(r.SERVER_ERROR),e.new_list_input_lock=!1})}},e.feeding=!1,e.feed=function(){e.feeding=!0;var t=e.lists[e.lists.length-1],n=t&&t.created?t.created:"";s.feed(e.credentials,n).then(function(t){if(e.loaded=!0,t.success)for(var n=0;n<t.lists.length;n++){t.lists[n].done_items=0;for(var s=0;s<t.lists[n].items.length;s++)t.lists[n].items[s].done&&t.lists[n].done_items++;e.lists.push(t.lists[n])}else alert(r.SERVER_ERROR);e.feeding=!1})}}]),angular.module("sendlist.LoginController",[]).controller("LoginController",["$scope","Facebook","AuthService","MESSAGES","EVENTS",function(e,t,n,s,i){e.data={},e.facebookLogin=function(){t.login(function(t){return"connected"!==t.status?null:void n.facebookSignup(t.authResponse.accessToken).then(function(t){t.success?e.$emit(i.LOGIN_SUCCESS,t.credentials):alert(s.SERVER_ERROR)})})},e.emailLogin=function(){}}]),angular.module("sendlist.MainController",[]).controller("MainController",["$scope","$state","$rootScope","EVENTS","MultimediaService",function(e,t,n,s,i){e.multimedia=i,e.state=t,e.credentials=n.credentials,n.$on(s.SESSION_READY,function(t,n){e.credentials=n}),e.logOut=function(){e.$emit(s.LOGOUT)}}]),angular.module("sendlist.NewListController",[]).controller("NewListController",["$scope","$rootScope","$state","$stateParams","ListsService","EVENTS","MESSAGES",function(e,t,n,s,i,r,o){e.credentials=t.credentials,e.list=s.list,e.list||i.find(e.credentials,s.id).then(function(t){t.success?e.list=t.list:n.go("not-found")}),e.addItem=function(){var t={text:e.text,done:!1};e.list.items.push(t),e.text="",t.saved=!1,i.addItem(t,e.list,e.credentials).then(function(n){n.success?e.list.items=n.items:(e.list.items.splice(e.list.items.indexOf(t),1),alert(o.SERVER_ERROR))})},e.check=function(t){if(t.checklock)return!1;t.checklock=!0;var n=t.done;i.mark(t,e.list,e.credentials).then(function(e){e.success||(t.done=!n),t.checklock=!1})}}]),angular.module("input-directives",[]).directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),angular.module("scroll-directive",[]).directive("ngScrolled",function(){return function(e,t,n){var s=t[0];t.bind("scroll",function(){s.scrollTop+s.offsetHeight>=s.scrollHeight&&e.$apply(n.ngScrolled)})}}),angular.module("sendlist.AuthService",[]).factory("AuthService",["$http",function(e){return{facebookSignup:function(t){return e.post("/signup/facebook",{fb_access_token:t}).then(function(e){return{success:!0,credentials:{key:e.data.key,user:e.data.user}}},function(){return{success:!1}})}}}]),angular.module("sendlist.ListsService",["sendlist.SignService"]).factory("ListsService",["$http","SignService",function(e,t){return{find:function(n,s){var i="/lists/"+s,r=t.getSignedHeaders(i,n.key,n.user._id);return e.get(i,{headers:r}).then(function(e){return{success:!0,list:e.data.list}},function(){return{success:!1}})},feed:function(n,s){var i="/lists?before="+s,r=t.getSignedHeaders(i,n.key,n.user._id);return e.get(i,{headers:r}).then(function(e){return{success:!0,lists:e.data.data}},function(){return{success:!1}})},add:function(n,s){var i="/lists",r=t.getSignedHeaders(i,s.key,s.user._id,n);return e.post(i,n,{headers:r}).then(function(e){return{success:!0,list:e.data.list}},function(){return{success:!1}})},addItem:function(n,s,i){var r="/lists/"+s._id,o={new_items:[n]},l=t.getSignedHeaders(r,i.key,i.user._id,o);return e.put(r,o,{headers:l}).then(function(e){return{success:!0,items:e.data.items}},function(){return{success:!1}})},mark:function(n,s,i){var r="/lists/"+s._id,o={item_done:n._id,done:n.done},l=t.getSignedHeaders(r,i.key,i.user._id,o);return e.put(r,o,{headers:l}).then(function(e){return{success:!0,items:e.data.items}},function(){return{success:!1}})}}}]),angular.module("sendlist.MultimediaService",[]).factory("MultimediaService",["$http",function(e){return{userpic:function(e){return e.facebook_id?"//graph.facebook.com/"+e.facebook_id+"/picture":"//img/default-user.jpg"}}}]),angular.module("sendlist.SessionService",[]).factory("SessionService",[function(){var e=window.sessionStorage;return{read:function(){var t={};try{t=JSON.parse(e.credentials)}catch(n){return delete e.credentials,{}}return"string"==typeof t.key&&t.user&&t.user._id&&"string"==typeof t.user._id?t:(delete e.credentials,{})},store:function(t){"string"==typeof t.key&&t.user&&t.user._id&&"string"==typeof t.user._id&&(e.credentials=angular.toJson(t))},"delete":function(){delete e.credentials}}}]),angular.module("sendlist.SignService",["external"]).factory("SignService",["jsSHA",function(e){return{getSignedHeaders:function(t,n,s,i){i=i||{};var r=angular.toJson(i)+t+n,o=new e("SHA-256","TEXT");o.update(r);var l={user_id:s,token:o.getHash("HEX")};return l}}}]);